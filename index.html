<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watercolor Washes Creator</title>
    <script src="https://unpkg.com/@spreadtheweb/multi-range-slider@1.0.2/dist/range-slider.main.min.js"></script>
    <style>
        :root {
            --background-color: #1a1a1a;
            --text-color: #f0f0f0;
            --primary-color: #4a90e2;
            --sidebar-bg: #2c2c2c;
            --border-color: #444;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--sidebar-bg);
        }

        .app-name {
            font-size: 1.5rem;
            font-weight: bold;
        }

        #initial-upload-view {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        .upload-box {
            border: 2px dashed var(--border-color);
            padding: 2rem 4rem;
            text-align: center;
        }

        #main-content-view {
            display: flex;
            flex-grow: 1;
        }

        .sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            border-right: 1px solid var(--border-color);
        }

        .sidebar h2 {
            margin-top: 0;
        }

        .image-preview-container canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--border-color);
        }

        .content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        #wash-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .wash-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .wash {
             max-width: 100%;
             height: auto;
             border: 1px solid var(--border-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            opacity: 0.9;
        }

        .grayscale {
            filter: grayscale(100%);
        }
    </style>
</head>
<body>
    <header>
        <div class="app-name">Watercolor Washes Creator</div>
        <nav>
            <!-- Navigation links can go here -->
        </nav>
    </header>

    <div id="initial-upload-view">
        <div class="upload-box">
            <input type="file" id="upload" accept="image/*">
            <p>Upload an image to get started.</p>
        </div>
    </div>

    <main id="main-content-view" style="display: none;">
        <aside class="sidebar">
            <div class="image-preview-container">
                <canvas id="canvas" width="300" height="225"></canvas>
            </div>
            <h2>Adjust Wash Levels</h2>
            <div class="range-slider" style="width: 200px; margin: 0 auto 20px;"></div>
            <button id="generate-washes">Generate Washes</button>
            <button id="toggle-grayscale">Toggle Grayscale</button>
            <div class="new-upload-form">
                <input type="file" id="new-upload" accept="image/*">
            </div>
        </aside>
        <section class="content">
            <div id="wash-preview"></div>
        </section>
    </main>

    <script>
        // Elements
        const uploadInput = document.getElementById('upload');
        const newUploadInput = document.getElementById('new-upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let lightEnd = 170;
        let mediumEnd = 85;

        const generateBtn = document.getElementById('generate-washes');
        const toggleGrayBtn = document.getElementById('toggle-grayscale');

        let uploadedImage = null;
        let grayscaleActive = false;

        // Wire up events
        uploadInput.addEventListener('change', handleFileUpload);
        newUploadInput.addEventListener('change', handleFileUpload);


        let rangeSlider = new RangeSlider('.range-slider', {
            values: [85, 170],
            min: 0,
            max: 255,
            step: 1,
        });

        rangeSlider.onChange(values => {
            // Higher value is the light boundary, lower is the medium/dark boundary
            lightEnd = Math.max(values[0], values[1]);
            mediumEnd = Math.min(values[0], values[1]);
            updateWashes();
        });

        generateBtn.addEventListener('click', updateWashes);

        toggleGrayBtn.addEventListener('click', () => {
            grayscaleActive = !grayscaleActive;
            if (grayscaleActive) {
                canvas.classList.add('grayscale');
            } else {
                canvas.classList.remove('grayscale');
            }
            // update preview canvases as well
            document.querySelectorAll('.wash').forEach(c => {
                if (grayscaleActive) c.classList.add('grayscale'); else c.classList.remove('grayscale');
            });
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();

            reader.onload = function(e) {
                uploadedImage = new Image();
                // Attach onload handler *before* setting src
                uploadedImage.onload = function() {
                    // Draw a scaled preview on the sidebar canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    const scale = Math.min(canvas.width / uploadedImage.width, canvas.height / uploadedImage.height);
                    const imgW = Math.round(uploadedImage.width * scale);
                    const imgH = Math.round(uploadedImage.height * scale);
                    const x = Math.round((canvas.width - imgW) / 2);
                    const y = Math.round((canvas.height - imgH) / 2);
                    ctx.drawImage(uploadedImage, x, y, imgW, imgH);

                    updateWashes(); // Generate initial washes

                    // Switch views
                    document.getElementById('initial-upload-view').style.display = 'none';
                    document.getElementById('main-content-view').style.display = 'flex';
                };
                uploadedImage.src = e.target.result; // Set src to trigger loading
            };
            reader.readAsDataURL(file);
        }

        function updateWashes() {
            if (!uploadedImage) return;

            // Create a fresh offscreen canvas for processing
            const processCanvas = document.createElement('canvas');
            processCanvas.width = uploadedImage.width;
            processCanvas.height = uploadedImage.height;
            const processCtx = processCanvas.getContext('2d');
            processCtx.drawImage(uploadedImage, 0, 0);

            const imageData = processCtx.getImageData(0, 0, uploadedImage.width, uploadedImage.height);
            const data = imageData.data;

            const washes = [
                createWash(data, lightEnd, 255, uploadedImage.width, uploadedImage.height), // Light wash
                createWash(data, mediumEnd, lightEnd, uploadedImage.width, uploadedImage.height), // Medium wash
                createWash(data, 0, mediumEnd, uploadedImage.width, uploadedImage.height) // Dark wash
            ];

            displayWashes(washes);
        }

        function createWash(data, low, high, width, height) {
            const newData = new Uint8ClampedArray(data.length);

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
                const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;

                if (luminance >= low && luminance <= high) {
                    newData[i] = r;
                    newData[i+1] = g;
                    newData[i+2] = b;
                    newData[i+3] = a;
                } else {
                    newData[i] = 255;
                    newData[i+1] = 255;
                    newData[i+2] = 255;
                    newData[i+3] = 0; // Make transparent
                }
            }

            return new ImageData(newData, width, height);
        }

        function displayWashes(washes) {
            const previewContainer = document.getElementById('wash-preview');
            previewContainer.innerHTML = ''; // Clear previous previews

            washes.forEach((washData, index) => {
                const washCanvas = document.createElement('canvas');
                washCanvas.width = washData.width;
                washCanvas.height = washData.height;
                const washCtx = washCanvas.getContext('2d');

                // Draw each wash on its own canvas
                washCtx.putImageData(washData, 0, 0);
                washCanvas.className = 'wash';
                if (grayscaleActive) washCanvas.classList.add('grayscale');

                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = 'Download';
                downloadBtn.addEventListener('click', () => {
                    const link = document.createElement('a');
                    link.download = `wash-${index}.png`;
                    link.href = washCanvas.toDataURL();
                    link.click();
                });

                const washContainer = document.createElement('div');
                washContainer.className = 'wash-container';
                washContainer.appendChild(washCanvas);
                washContainer.appendChild(downloadBtn);

                previewContainer.appendChild(washContainer);
            });
        }
    </script>
</body>
</html>

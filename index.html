<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watercolor Washes Creator</title>
    <script src="https://unpkg.com/@spreadtheweb/multi-range-slider@1.0.2/dist/range-slider.main.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }

        canvas {
            border: 1px solid #ccc;
            max-width: 90%;
            height: auto;
        }

        #wash-preview {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .wash {
            margin: 0 10px;
            max-width: 300px;
        }

        .wash-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
            height: auto;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .grayscale {
            filter: grayscale(100%);
        }
    </style>
</head>
<body>
    <h1>Watercolor Washes Creator</h1>
    <input type="file" id="upload" accept="image/*">
    <canvas id="canvas" width="800" height="600"></canvas>

    <h2>Adjust Wash Levels</h2>

    <div class="range-slider" style="width: 300px; margin: 0 auto 20px;"></div>

    <button id="generate-washes">Generate Washes</button>
    <button id="toggle-grayscale">Toggle Grayscale</button> 

    <h2>Wash Previews</h2>
    <div id="wash-preview"></div>

    <script>
        // Elements
        const uploadInput = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let lightEnd = 170;
        let mediumEnd = 85;

        const generateBtn = document.getElementById('generate-washes');
        const toggleGrayBtn = document.getElementById('toggle-grayscale');

        let uploadedImage = null;
        let imgW = 0, imgH = 0; // scaled image size for processing
        let grayscaleActive = false;

        // Wire up events
        uploadInput.addEventListener('change', handleFileUpload);

        let rangeSlider = new RangeSlider('.range-slider', {
            values: [85, 170],
            min: 0,
            max: 255,
            step: 1,
        });

        rangeSlider.onInput(values => {
            // Higher value is the light boundary, lower is the medium/dark boundary
            lightEnd = Math.max(values[0], values[1]);
            mediumEnd = Math.min(values[0], values[1]);
            updateWashes();
        });

        generateBtn.addEventListener('click', updateWashes);

        toggleGrayBtn.addEventListener('click', () => {
            grayscaleActive = !grayscaleActive;
            if (grayscaleActive) {
                canvas.classList.add('grayscale');
            } else {
                canvas.classList.remove('grayscale');
            }
            // update preview canvases as well
            document.querySelectorAll('.wash').forEach(c => {
                if (grayscaleActive) c.classList.add('grayscale'); else c.classList.remove('grayscale');
            });
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();

            reader.onload = function(e) {
                uploadedImage = new Image();
                uploadedImage.src = e.target.result;
                uploadedImage.onload = function() {
                    // Draw image on main canvas preserving aspect ratio (contain)
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    const scale = Math.min(canvas.width / uploadedImage.width, canvas.height / uploadedImage.height);
                    imgW = Math.round(uploadedImage.width * scale);
                    imgH = Math.round(uploadedImage.height * scale);
                    const x = Math.round((canvas.width - imgW) / 2);
                    const y = Math.round((canvas.height - imgH) / 2);
                    ctx.drawImage(uploadedImage, x, y, imgW, imgH);

                    updateWashes(); // Generate initial washes
                };
            };
            reader.readAsDataURL(file);
        }

        function updateWashes() {
            if (!uploadedImage) return;

            // Create a fresh offscreen canvas for processing
            const processCanvas = document.createElement('canvas');
            processCanvas.width = imgW;
            processCanvas.height = imgH;
            const processCtx = processCanvas.getContext('2d');
            processCtx.drawImage(uploadedImage, 0, 0, imgW, imgH);

            const imageData = processCtx.getImageData(0, 0, imgW, imgH);
            const data = imageData.data;

            const washes = [
                createWash(data, lightEnd, 255, imgW, imgH), // Light wash
                createWash(data, mediumEnd, lightEnd, imgW, imgH), // Medium wash
                createWash(data, 0, mediumEnd, imgW, imgH) // Dark wash
            ];

            displayWashes(washes);
        }

        function createWash(data, low, high, width, height) {
            const newData = new Uint8ClampedArray(data.length);

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
                const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;

                if (luminance >= low && luminance <= high) {
                    newData[i] = r;
                    newData[i+1] = g;
                    newData[i+2] = b;
                    newData[i+3] = a;
                } else {
                    newData[i] = 255;
                    newData[i+1] = 255;
                    newData[i+2] = 255;
                    newData[i+3] = 0; // Make transparent
                }
            }

            return new ImageData(newData, width, height);
        }

        function displayWashes(washes) {
            const previewContainer = document.getElementById('wash-preview');
            previewContainer.innerHTML = ''; // Clear previous previews

            washes.forEach((washData, index) => {
                const washCanvas = document.createElement('canvas');
                washCanvas.width = washData.width;
                washCanvas.height = washData.height;
                const washCtx = washCanvas.getContext('2d');

                // Draw each wash on its own canvas
                washCtx.putImageData(washData, 0, 0);
                washCanvas.className = 'wash';
                if (grayscaleActive) washCanvas.classList.add('grayscale');

                // Make sure it's visible fully and responsive
                washCanvas.style.maxWidth = '300px';
                washCanvas.style.height = 'auto';

                const downloadBtn = document.createElement('button');
                downloadBtn.textContent = 'Download';
                downloadBtn.addEventListener('click', () => {
                    const link = document.createElement('a');
                    link.download = `wash-${index}.png`;
                    link.href = washCanvas.toDataURL();
                    link.click();
                });

                const washContainer = document.createElement('div');
                washContainer.className = 'wash-container';
                washContainer.appendChild(washCanvas);
                washContainer.appendChild(downloadBtn);

                previewContainer.appendChild(washContainer);
            });
        }
    </script>
</body>
</html>

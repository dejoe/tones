<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watercolor Washes Creator</title>
    <script src="https://unpkg.com/@spreadtheweb/multi-range-slider@1.0.2/dist/range-slider.main.min.js"></script>
    <style>
        :root {
            --background-color: #1a1a1a;
            --text-color: #f0f0f0;
            --primary-color: #4a90e2;
            --sidebar-bg: #2c2c2c;
            --border-color: #444;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--sidebar-bg);
        }

        .app-name {
            font-size: 1.5rem;
            font-weight: bold;
        }

        #initial-upload-view {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        .upload-box {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 2rem 4rem;
            text-align: center;
            background-color: var(--sidebar-bg);
        }

        #main-content-view {
            display: flex;
            flex-grow: 1;
        }

        .sidebar {
            width: 320px;
            background-color: var(--sidebar-bg);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            border-right: 1px solid var(--border-color);
        }

        .sidebar h2 {
            margin-top: 0;
        }

        .image-preview-container canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--border-color);
        }

        .content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }

        #wash-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .wash-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .wash {
             max-width: 100%;
             height: auto;
             border: 1px solid var(--border-color);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 9999px;
        }

        button:hover, .file-upload-label:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn-icon {
            width: 1.2em;
            height: 1.2em;
            margin-right: 0.5em;
            vertical-align: middle;
        }

        .grayscale {
            filter: grayscale(100%);
        }

        /* Slider Styles */
        .range-slider {
            --primary-color: #4a90e2; /* Re-using the primary color for the slider */
            --thumb-color: #f0f0f0;
            --track-color: #444;
        }

        .range-slider__rail {
            background-color: var(--track-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            height: 8px;
        }

        .range-slider__track {
            background-color: var(--primary-color);
        }

        .range-slider__point {
            background-color: var(--primary-color);
            position: relative;
            z-index: 1;
        }

        /* Add padding to the slider container to prevent thumbs from overflowing */
        .sidebar .range-slider {
            box-sizing: border-box;
            padding: 0 15px;
        }

        /* Modern File Upload Button */
        .file-upload-input {
            display: none;
        }

        .file-upload-label {
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-radius: 9999px;
            display: inline-block;
        }

        .file-upload-label:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <header>
        <div class="app-name">Watercolor Washes Creator</div>
        <nav>
            <!-- Navigation links can go here -->
        </nav>
    </header>

    <div id="initial-upload-view">
        <div class="upload-box">
            <div class="file-upload-wrapper">
                <input type="file" id="upload" accept="image/*" class="file-upload-input">
                <label for="upload" class="file-upload-label">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="btn-icon">
                        <path fill-rule="evenodd" d="M11.47 2.47a.75.75 0 0 1 1.06 0l4.5 4.5a.75.75 0 0 1-1.06 1.06l-3.22-3.22V16.5a.75.75 0 0 1-1.5 0V4.81L8.03 8.03a.75.75 0 0 1-1.06-1.06l4.5-4.5ZM3 15.75a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd"/>
                    </svg>
                    Choose a file
                </label>
            </div>
            <p>Upload an image to get started.</p>
        </div>
    </div>

    <main id="main-content-view" style="display: none;">
        <aside class="sidebar">
            <div class="image-preview-container">
                <canvas id="canvas" width="300" height="225"></canvas>
            </div>
            <h2>Adjust Wash Levels</h2>
            <div class="range-slider" style="width: 200px; margin: 0 auto 20px;"></div>
            <button id="generate-washes">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="btn-icon">
                  <path fill-rule="evenodd" d="M9 4.5a.75.75 0 0 1 .721.544l.813 2.846a3.75 3.75 0 0 0 2.576 2.576l2.846.813a.75.75 0 0 1 0 1.442l-2.846.813a3.75 3.75 0 0 0-2.576 2.576l-.813 2.846a.75.75 0 0 1-1.442 0l-.813-2.846a3.75 3.75 0 0 0-2.576-2.576l-2.846-.813a.75.75 0 0 1 0-1.442l2.846-.813A3.75 3.75 0 0 0 7.466 7.89l.813-2.846A.75.75 0 0 1 9 4.5ZM18 1.5a.75.75 0 0 1 .728.568l.258 1.036c.236.94.97 1.674 1.91 1.91l1.036.258a.75.75 0 0 1 0 1.456l-1.036.258c-.94.236-1.674.97-1.91 1.91l-.258 1.036a.75.75 0 0 1-1.456 0l-.258-1.036a2.625 2.625 0 0 0-1.91-1.91l-1.036-.258a.75.75 0 0 1 0-1.456l1.036-.258a2.625 2.625 0 0 0 1.91-1.91l.258-1.036A.75.75 0 0 1 18 1.5ZM16.5 15a.75.75 0 0 1 .712.513l.394 1.183c.15.447.5.799.948.948l1.183.395a.75.75 0 0 1 0 1.422l-1.183.395c-.447.15-.799.5-.948.948l-.395 1.183a.75.75 0 0 1-1.422 0l-.395-1.183a1.5 1.5 0 0 0-.948-.948l-1.183-.395a.75.75 0 0 1 0-1.422l1.183-.395c.447-.15.799-.5.948-.948l.395-1.183A.75.75 0 0 1 16.5 15Z" clip-rule="evenodd"/>
                </svg>
                Generate Washes
            </button>
            <button id="toggle-grayscale">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="btn-icon">
                    <path fill-rule="evenodd" d="M2.25 4.125c0-1.036.84-1.875 1.875-1.875h5.25c1.036 0 1.875.84 1.875 1.875V17.25a4.5 4.5 0 1 1-9 0V4.125Zm4.5 14.25a1.125 1.125 0 1 0 0-2.25 1.125 1.125 0 0 0 0 2.25Z" clip-rule="evenodd"/>
                    <path d="M10.719 21.75h9.156c1.036 0 1.875-.84 1.875-1.875v-5.25c0-1.036-.84-1.875-1.875-1.875h-.14l-8.742 8.743c-.09.089-.18.175-.274.257ZM12.738 17.625l6.474-6.474a1.875 1.875 0 0 0 0-2.651L15.5 4.787a1.875 1.875 0 0 0-2.651 0l-.1.099V17.25c0 .126-.003.251-.01.375Z"/>
                </svg>
                Toggle Grayscale
            </button>
            <div class="new-upload-form">
                <div class="file-upload-wrapper">
                    <input type="file" id="new-upload" accept="image/*" class="file-upload-input">
                    <label for="new-upload" class="file-upload-label">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="btn-icon">
                           <path fill-rule="evenodd" d="M11.47 2.47a.75.75 0 0 1 1.06 0l4.5 4.5a.75.75 0 0 1-1.06 1.06l-3.22-3.22V16.5a.75.75 0 0 1-1.5 0V4.81L8.03 8.03a.75.75 0 0 1-1.06-1.06l4.5-4.5ZM3 15.75a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd"/>
                        </svg>
                        Upload new image
                    </label>
                </div>
            </div>
        </aside>
        <section class="content">
            <div id="wash-preview"></div>
        </section>
    </main>

    <script>
        // Elements
        const uploadInput = document.getElementById('upload');
        const newUploadInput = document.getElementById('new-upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        let lightEnd = 170;
        let mediumEnd = 85;

        const generateBtn = document.getElementById('generate-washes');
        const toggleGrayBtn = document.getElementById('toggle-grayscale');

        let uploadedImage = null;
        let grayscaleActive = false;
        let rangeSlider = null;

        // Wire up events
        uploadInput.addEventListener('change', handleFileUpload);
        newUploadInput.addEventListener('change', handleFileUpload);

        // Debounce function to limit how often a function can run
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        const debouncedUpdateWashes = debounce(updateWashes, 250);

        generateBtn.addEventListener('click', updateWashes);

        toggleGrayBtn.addEventListener('click', () => {
            grayscaleActive = !grayscaleActive;
            if (grayscaleActive) {
                canvas.classList.add('grayscale');
            } else {
                canvas.classList.remove('grayscale');
            }
            // update preview canvases as well
            document.querySelectorAll('.wash').forEach(c => {
                if (grayscaleActive) c.classList.add('grayscale'); else c.classList.remove('grayscale');
            });
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();

            reader.onload = function(e) {
                uploadedImage = new Image();
                // Attach onload handler *before* setting src
                uploadedImage.onload = function() {
                    // Draw a scaled preview on the sidebar canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    const scale = Math.min(canvas.width / uploadedImage.width, canvas.height / uploadedImage.height);
                    const imgW = Math.round(uploadedImage.width * scale);
                    const imgH = Math.round(uploadedImage.height * scale);
                    const x = Math.round((canvas.width - imgW) / 2);
                    const y = Math.round((canvas.height - imgH) / 2);
                    ctx.drawImage(uploadedImage, x, y, imgW, imgH);

                    updateWashes(); // Generate initial washes

                    // Switch views
                    document.getElementById('initial-upload-view').style.display = 'none';
                    document.getElementById('main-content-view').style.display = 'flex';

                    // Initialize the slider now that it's visible
                    if (!rangeSlider) {
                        rangeSlider = new RangeSlider('.range-slider', {
                            values: [85, 170],
                            min: 0,
                            max: 255,
                            step: 1,
                        });

                        rangeSlider.onChange(values => {
                            // Higher value is the light boundary, lower is the medium/dark boundary
                            lightEnd = Math.max(values[0], values[1]);
                            mediumEnd = Math.min(values[0], values[1]);
                            debouncedUpdateWashes();
                        });
                    }
                };
                uploadedImage.src = e.target.result; // Set src to trigger loading
            };
            reader.readAsDataURL(file);
        }

        function updateWashes() {
            if (!uploadedImage) return;

            // Create a fresh offscreen canvas for processing
            const processCanvas = document.createElement('canvas');
            processCanvas.width = uploadedImage.width;
            processCanvas.height = uploadedImage.height;
            const processCtx = processCanvas.getContext('2d');
            processCtx.drawImage(uploadedImage, 0, 0);

            const imageData = processCtx.getImageData(0, 0, uploadedImage.width, uploadedImage.height);
            const data = imageData.data;

            const washes = [
                createWash(data, lightEnd, 255, uploadedImage.width, uploadedImage.height), // Light wash
                createWash(data, mediumEnd, lightEnd, uploadedImage.width, uploadedImage.height), // Medium wash
                createWash(data, 0, mediumEnd, uploadedImage.width, uploadedImage.height) // Dark wash
            ];

            displayWashes(washes);
        }

        function createWash(data, low, high, width, height) {
            const newData = new Uint8ClampedArray(data.length);

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i], g = data[i+1], b = data[i+2], a = data[i+3];
                const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;

                if (luminance >= low && luminance <= high) {
                    newData[i] = r;
                    newData[i+1] = g;
                    newData[i+2] = b;
                    newData[i+3] = a;
                } else {
                    newData[i] = 255;
                    newData[i+1] = 255;
                    newData[i+2] = 255;
                    newData[i+3] = 0; // Make transparent
                }
            }

            return new ImageData(newData, width, height);
        }

        function displayWashes(washes) {
            const previewContainer = document.getElementById('wash-preview');
            previewContainer.innerHTML = ''; // Clear previous previews

            washes.forEach((washData, index) => {
                const washCanvas = document.createElement('canvas');
                washCanvas.width = washData.width;
                washCanvas.height = washData.height;
                const washCtx = washCanvas.getContext('2d');

                // Draw each wash on its own canvas
                washCtx.putImageData(washData, 0, 0);
                washCanvas.className = 'wash';
                if (grayscaleActive) washCanvas.classList.add('grayscale');

                const downloadBtn = document.createElement('button');
                downloadBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="btn-icon">
                        <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-4.5 4.5a.75.75 0 0 1-1.06 0l-4.5-4.5a.75.75 0 1 1 1.06-1.06l3.22 3.22V3a.75.75 0 0 1 .75-.75Zm-9 13.5a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75Z" clip-rule="evenodd"/>
                    </svg>
                    Download
                `;
                downloadBtn.addEventListener('click', () => {
                    const link = document.createElement('a');
                    link.download = `wash-${index}.png`;
                    link.href = washCanvas.toDataURL();
                    link.click();
                });

                const washContainer = document.createElement('div');
                washContainer.className = 'wash-container';
                washContainer.appendChild(washCanvas);
                washContainer.appendChild(downloadBtn);

                previewContainer.appendChild(washContainer);
            });
        }
    </script>
</body>
</html>
